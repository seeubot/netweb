<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTT Content Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .card:hover, .card:focus {
            transform: scale(1.05);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }
        .player-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 50;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .video-player {
            width: 90%;
            max-height: 90vh;
        }
        .close-player {
            position: absolute;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 9999px;
            width: 3rem;
            height: 3rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .close-player:hover, .close-player:focus {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }
        .mx-player-button:hover, .mx-player-button:focus {
            background-color: #f7a400;
        }
        .web-player-button:hover, .web-player-button:focus {
            background-color: #007bff;
        }
        .thumbnail-img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-6">

    <h1 class="text-3xl sm:text-4xl font-bold text-center mb-10 text-white">OTT Content Hub</h1>

    <!-- Loading message -->
    <div id="loading-message" class="text-center text-lg text-gray-400">Loading content...</div>
    <div id="error-message" class="hidden text-center text-lg text-red-500">
        Failed to load content. Please try again later.
    </div>

    <!-- Player Container -->
    <div id="playerContainer" class="player-container">
        <button id="closePlayerBtn" class="close-player">✖</button>
        <video id="videoPlayer" class="video-player" controls autoplay playsinline></video>
    </div>

    <!-- Movies Section -->
    <div id="movies-section" class="hidden mb-12">
        <h2 class="text-2xl font-bold mb-4 text-blue-400">Movies</h2>
        <div id="movies-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
            <!-- Movie cards will be injected here by JS -->
        </div>
    </div>

    <!-- Series Section -->
    <div id="series-section" class="hidden mb-12">
        <h2 class="text-2xl font-bold mb-4 text-purple-400">Series</h2>
        <div id="series-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-6">
            <!-- Series cards will be injected here by JS -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const moviesList = document.getElementById('movies-list');
            const seriesList = document.getElementById('series-list');
            const playerContainer = document.getElementById('playerContainer');
            const videoPlayer = document.getElementById('videoPlayer');
            const closePlayerBtn = document.getElementById('closePlayerBtn');
            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const moviesSection = document.getElementById('movies-section');
            const seriesSection = document.getElementById('series-section');

            // Auto-detect the current domain or use environment variable
            const BOT_API_URL = window.location.origin;
            const CONTENT_ENDPOINT = `${BOT_API_URL}/ott_content`;

            console.log('Fetching content from:', CONTENT_ENDPOINT);

            async function fetchOttContent() {
                try {
                    const response = await fetch(CONTENT_ENDPOINT, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                    
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('Received data:', data);
                    renderContent(data);
                } catch (error) {
                    console.error('Error fetching OTT content:', error);
                    loadingMessage.classList.add('hidden');
                    errorMessage.textContent = `Error: ${error.message}. Make sure the bot is running and has OTT content.`;
                    errorMessage.classList.remove('hidden');
                }
            }

            function renderContent(ottContent) {
                loadingMessage.classList.add('hidden');
                
                moviesList.innerHTML = '';
                seriesList.innerHTML = '';

                let hasMovies = false;
                let hasSeries = false;

                if (!Array.isArray(ottContent) || ottContent.length === 0) {
                    errorMessage.textContent = "No content available. Please add some content via the bot's admin panel.";
                    errorMessage.classList.remove('hidden');
                    return;
                }

                ottContent.forEach(item => {
                    if (item.type === 'movie') {
                        moviesList.appendChild(createMovieCard(item));
                        hasMovies = true;
                    } else if (item.type === 'series') {
                        seriesList.appendChild(createSeriesCard(item));
                        hasSeries = true;
                    }
                });
                
                if (hasMovies) moviesSection.classList.remove('hidden');
                if (hasSeries) seriesSection.classList.remove('hidden');
                
                if (!hasMovies && !hasSeries) {
                    errorMessage.textContent = "No movies or series found. Please add content via the bot.";
                    errorMessage.classList.remove('hidden');
                }
                
                updateFocusableElements();
            }

            function createMovieCard(movie) {
                const card = document.createElement('div');
                card.className = 'card w-full bg-gray-800 rounded-xl shadow-xl overflow-hidden cursor-pointer transition-transform duration-200';
                card.setAttribute('tabindex', '0');
                
                const thumbnailUrl = movie.thumbnail || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzMzMzMzMyIvPgogIDx0ZXh0IHg9IjEwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
                
                card.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${movie.name}" class="thumbnail-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzMzMzMzMyIvPgogIDx0ZXh0IHg9IjEwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="p-4">
                        <h3 class="text-sm font-bold text-center truncate">${movie.name}</h3>
                        <div class="flex justify-center mt-2">
                            <span class="bg-blue-600 text-xs px-2 py-1 rounded">Movie</span>
                        </div>
                    </div>
                `;
                card.onclick = () => showPlayOptions(movie.name, movie.streaming_url);
                return card;
            }

            function createSeriesCard(series) {
                const card = document.createElement('div');
                card.className = 'card w-full bg-gray-800 rounded-xl shadow-xl overflow-hidden cursor-pointer transition-transform duration-200';
                card.setAttribute('tabindex', '0');
                
                const thumbnailUrl = series.thumbnail || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzMzMzMzMyIvPgogIDx0ZXh0IHg9IjEwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K';
                
                const totalEpisodes = series.seasons?.reduce((total, season) => total + (season.episodes?.length || 0), 0) || 0;
                
                card.innerHTML = `
                    <img src="${thumbnailUrl}" alt="${series.name}" class="thumbnail-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzMzMzMzMyIvPgogIDx0ZXh0IHg9IjEwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiNmZmYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPk5vIEltYWdlPC90ZXh0Pgo8L3N2Zz4K'">
                    <div class="p-4">
                        <h3 class="text-sm font-bold text-center truncate">${series.name}</h3>
                        <div class="flex justify-center mt-2 space-x-1">
                            <span class="bg-purple-600 text-xs px-2 py-1 rounded">Series</span>
                            <span class="bg-gray-600 text-xs px-2 py-1 rounded">${series.seasons?.length || 0} Seasons</span>
                            <span class="bg-gray-600 text-xs px-2 py-1 rounded">${totalEpisodes} Episodes</span>
                        </div>
                    </div>
                `;
                card.onclick = () => showSeasonEpisodeSelector(series);
                return card;
            }

            function showPlayOptions(title, url) {
                if (!url) {
                    alert('No streaming URL available for this content.');
                    return;
                }
                const playerOptions = document.createElement('div');
                playerOptions.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
                playerOptions.innerHTML = `
                    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl text-center">
                        <h3 class="text-xl font-bold mb-4">Play "${title}"</h3>
                        <div class="flex space-x-4">
                            <button id="webPlayerBtn" class="web-player-button bg-blue-600 text-white px-6 py-3 rounded-lg font-bold transition-colors duration-200">
                                🌐 Web Player
                            </button>
                            <a href="intent:${url}#Intent;package=com.mxtech.videoplayer.ad;S.title=${encodeURIComponent(title)};end" 
                                class="mx-player-button bg-yellow-500 text-black px-6 py-3 rounded-lg font-bold transition-colors duration-200 flex items-center justify-center no-underline">
                                📱 MX Player
                            </a>
                        </div>
                        <button id="closeOptionsBtn" class="mt-6 text-red-400 hover:text-red-300">❌ Cancel</button>
                    </div>
                `;
                document.body.appendChild(playerOptions);

                document.getElementById('webPlayerBtn').onclick = () => {
                    playInWebPlayer(url);
                    playerOptions.remove();
                };
                document.getElementById('closeOptionsBtn').onclick = () => playerOptions.remove();
                
                // Close on background click
                playerOptions.onclick = (e) => {
                    if (e.target === playerOptions) playerOptions.remove();
                };
            }

            function playInWebPlayer(url) {
                videoPlayer.src = url;
                playerContainer.style.display = 'flex';
                videoPlayer.play().catch(e => {
                    console.error('Error playing video:', e);
                    alert('Error playing video. The URL might be invalid or the video format is not supported.');
                });
            }

            function showSeasonEpisodeSelector(series) {
                if (!series.seasons || series.seasons.length === 0) {
                    alert('No seasons available for this series.');
                    return;
                }
                
                const selector = document.createElement('div');
                selector.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                selector.innerHTML = `
                    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-6 text-center">${series.name}</h3>
                        ${series.seasons.map((season, seasonIndex) => `
                            <div class="mb-6">
                                <h4 class="text-lg font-semibold mb-3 text-purple-400">${season.season_name}</h4>
                                ${season.episodes && season.episodes.length > 0 ? `
                                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                                        ${season.episodes.map((episode, episodeIndex) => `
                                            <button class="bg-gray-700 text-white px-4 py-3 rounded-lg text-left hover:bg-blue-600 transition-colors duration-200 episode-btn"
                                                    onclick="showPlayOptions('${episode.episode_name}', '${episode.streaming_url}')">
                                                <div class="font-medium truncate">${episode.episode_name}</div>
                                                <div class="text-xs text-gray-300 mt-1">Episode ${episodeIndex + 1}</div>
                                            </button>
                                        `).join('')}
                                    </div>
                                ` : '<p class="text-gray-400">No episodes available</p>'}
                            </div>
                        `).join('')}
                        <button id="closeSelectorBtn" class="mt-6 w-full bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">❌ Close</button>
                    </div>
                `;
                document.body.appendChild(selector);
                document.getElementById('closeSelectorBtn').onclick = () => selector.remove();
                
                // Close on background click
                selector.onclick = (e) => {
                    if (e.target === selector) selector.remove();
                };
            }

            closePlayerBtn.onclick = () => {
                videoPlayer.pause();
                videoPlayer.src = '';
                playerContainer.style.display = 'none';
            };

            // Keyboard navigation for Android TV remote
            let currentFocus = 0;
            const focusableElements = [];

            const updateFocusableElements = () => {
                focusableElements.length = 0;
                document.querySelectorAll('a[href], button, [tabindex="0"]').forEach(el => {
                    if (el.offsetParent !== null) { // Only visible elements
                        focusableElements.push(el);
                    }
                });
                if (focusableElements.length > 0) {
                    currentFocus = 0;
                    focusableElements[0].focus();
                }
            };
            
            document.body.addEventListener('keydown', (e) => {
                if (playerContainer.style.display === 'flex') {
                    // Handle keyboard events for the video player
                    if (e.key === 'Escape' || e.key === 'Backspace') {
                        closePlayerBtn.click();
                    }
                    return;
                }

                switch(e.key) {
                    case 'ArrowRight':
                        e.preventDefault();
                        currentFocus = (currentFocus + 1) % focusableElements.length;
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        currentFocus = (currentFocus - 1 + focusableElements.length) % focusableElements.length;
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        currentFocus = Math.min(currentFocus + 6, focusableElements.length - 1);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        currentFocus = Math.max(currentFocus - 6, 0);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        focusableElements[currentFocus]?.click();
                        return;
                    case 'Escape':
                    case 'Backspace':
                        // Close any open modals
                        document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.remove());
                        return;
                }
                
                if (focusableElements.length > 0 && focusableElements[currentFocus]) {
                    focusableElements[currentFocus].focus();
                }
            });

            // Touch/swipe support for mobile
            let touchStartX = 0;
            let touchStartY = 0;

            document.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            });

            document.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;

                // Minimum swipe distance
                if (Math.abs(diffX) > 50 || Math.abs(diffY) > 50) {
                    if (Math.abs(diffX) > Math.abs(diffY)) {
                        // Horizontal swipe
                        if (diffX > 0) {
                            // Swiped left - next item
                            currentFocus = (currentFocus + 1) % focusableElements.length;
                        } else {
                            // Swiped right - previous item
                            currentFocus = (currentFocus - 1 + focusableElements.length) % focusableElements.length;
                        }
                    }
                    
                    if (focusableElements.length > 0 && focusableElements[currentFocus]) {
                        focusableElements[currentFocus].focus();
                    }
                }
            });

            // Auto-refresh content every 30 seconds
            setInterval(fetchOttContent, 30000);

            // Fetch and render content on page load
            fetchOttContent();
        });
    </script>
</body>
</html>
